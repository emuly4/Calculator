<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LUFA Library - Printer Class Bootloader: Printer Class USB AVR Bootloader</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">LUFA Library - Printer Class Bootloader
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('index.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Printer Class USB AVR Bootloader </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="Sec_Compat"></a>
Demo Compatibility:</h1>
<p>The following list indicates what microcontrollers are compatible with this demo.</p>
<ul>
<li>Series 7 USB AVRs (AT90USBxxx7) </li>
<li>Series 6 USB AVRs (AT90USBxxx6) </li>
<li>Series 4 USB AVRs (ATMEGAxxU4) </li>
<li>Series 2 USB AVRs (AT90USBxx2, ATMEGAxxU2)</li>
</ul>
<h1><a class="anchor" id="Sec_Info"></a>
USB Information:</h1>
<p>The following table gives a rundown of the USB utilization of this demo.</p>
<table class="doxtable">
<tr>
<td><b>USB Mode:</b> </td><td>Device  </td></tr>
<tr>
<td><b>USB Class:</b> </td><td>Printer Class  </td></tr>
<tr>
<td><b>USB Subclass:</b> </td><td>Printer Subclass  </td></tr>
<tr>
<td><b>Relevant Standards:</b> </td><td>USBIF Printer Class Standard  </td></tr>
<tr>
<td><b>Supported USB Speeds:</b> </td><td>Full Speed Mode  </td></tr>
</table>
<h1><a class="anchor" id="Sec_Description"></a>
Project Description:</h1>
<p>This bootloader enumerates to the host as a Generic Text Only Printer device, capable of reading and parsing "printed" plain-text Intel HEX files to load firmware onto the AVR.</p>
<p>Out of the box this bootloader builds for the AT90USB1287 with an 8KB bootloader section size, and will fit into 4KB of bootloader space. If you wish to alter this size and/or change the AVR model, you will need to edit the MCU, FLASH_SIZE_KB and BOOT_SECTION_SIZE_KB values in the accompanying makefile.</p>
<p>When the bootloader is running, the board's LED(s) will flash at regular intervals to distinguish the bootloader from the normal user application.</p>
<h1><a class="anchor" id="Sec_Running"></a>
Running the Bootloader</h1>
<p>On the USB AVR8 devices, setting the <code>HWBE</code> device fuse will cause the bootloader to run if the <code>HWB</code> pin of the AVR is grounded when the device is reset.</p>
<p>The are two behaviours of this bootloader, depending on the device's fuses:</p>
<p><b>If the device's BOOTRST fuse is set</b>, the bootloader will run any time the system is reset from the external reset pin, unless no valid user application has been loaded. To initiate the bootloader, the device's external reset pin should be grounded momentarily.</p>
<p><b>If the device's BOOTRST fuse is not set</b>, the bootloader will run only if initiated via a software jump, or if the <code>HWB</code> pin was low during the last device reset (if the <code>HWBE</code> fuse is set).</p>
<p>For board specific exceptions to the above, see below.</p>
<h2><a class="anchor" id="SSec_XPLAIN"></a>
Atmel Xplain Board</h2>
<p>Ground the USB AVR JTAG's <code>TCK</code> pin to ground when powering on the board to start the bootloader. This assumes the <code>HWBE</code> fuse is cleared and the <code>BOOTRST</code> fuse is set as the HWBE pin is not user accessible on this board.</p>
<h2><a class="anchor" id="SSec_Leonardo"></a>
Arduino Leonardo Board</h2>
<p>Ground <code>IO13</code> when powering the board to start the bootloader. This assumes the <code>HWBE</code> fuse is cleared and the <code>BOOTRST</code> fuse is set as the HWBE pin is not user accessible on this board.</p>
<h1><a class="anchor" id="Sec_Installation"></a>
Driver Installation</h1>
<p>This bootloader uses the Generic Text-Only printer drivers inbuilt into all modern operating systems, thus no additional drivers need to be supplied for correct operation.</p>
<h1><a class="anchor" id="Sec_HostApp"></a>
Host Controller Application</h1>
<p>This bootloader is compatible with Notepad under Windows, and the command line <code>lpr</code> utility under Linux.</p>
<h2><a class="anchor" id="SSec_Notepad"></a>
Notepad (Windows)</h2>
<p>While most text applications under Windows will be compatible with the bootloader, the inbuilt Notepad utility is recommended as it will introduce minimal formatting changes to the output stream. To program with Notepad, open the target HEX file and print it to the Generic Text Only printer device the bootloader creates.</p>
<h2><a class="anchor" id="SSec_LPR"></a>
LPR (Linux)</h2>
<p>While the CUPS framework under Linux will enumerate the bootloader as a Generic Text-Only printer, many applications will refuse to print to the device due to the lack of rich formatting options available. As a result, under Linux HEX files must be printed via the low level <code>lpr</code> utility instead.</p>
<div class="fragment"><div class="line">cat Mouse.hex | lpr</div></div><!-- fragment --><h1><a class="anchor" id="Sec_API"></a>
User Application API</h1>
<p>Several user application functions for FLASH and other special memory area manipulations are exposed by the bootloader, allowing the user application to call into the bootloader at runtime to read and write FLASH data.</p>
<p>By default, the bootloader API jump table is located 32 bytes from the end of the device's FLASH memory, and follows the following layout:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define BOOTLOADER_API_TABLE_SIZE          32</span></div><div class="line"><span class="preprocessor">#define BOOTLOADER_API_TABLE_START         ((FLASHEND + 1UL) - BOOTLOADER_API_TABLE_SIZE)</span></div><div class="line"><span class="preprocessor">#define BOOTLOADER_API_CALL(Index)         (void*)((BOOTLOADER_API_TABLE_START + (Index * 2)) / 2)</span></div><div class="line"></div><div class="line">void    (*<a class="code" href="a00002.html#a24b83742d50698da694228c7e22430ad">BootloaderAPI_ErasePage</a>)(uint32_t Address)               = BOOTLOADER_API_CALL(0);</div><div class="line">void    (*<a class="code" href="a00002.html#a658514e1b5e6ea2ce0961f6f7e02dffb">BootloaderAPI_WritePage</a>)(uint32_t Address)               = BOOTLOADER_API_CALL(1);</div><div class="line">void    (*<a class="code" href="a00002.html#a56546f3c50d0a6df07c807034abaa9c6">BootloaderAPI_FillWord</a>)(uint32_t Address, uint16_t Word) = BOOTLOADER_API_CALL(2);</div><div class="line">uint8_t (*<a class="code" href="a00002.html#a5438f1b6859128f5e49e7e48ac2edd5d">BootloaderAPI_ReadSignature</a>)(uint16_t Address)           = BOOTLOADER_API_CALL(3);</div><div class="line">uint8_t (*<a class="code" href="a00002.html#a75fda26274bb7f8eb5ab4ec7f18480a6">BootloaderAPI_ReadFuse</a>)(uint16_t Address)                = BOOTLOADER_API_CALL(4);</div><div class="line">uint8_t (*<a class="code" href="a00002.html#a1d07523558f9d43e46b4d7c7aead42bd">BootloaderAPI_ReadLock</a>)(void)                            = BOOTLOADER_API_CALL(5);</div><div class="line">void    (*<a class="code" href="a00002.html#a7bbe71ef5d5ca96c3beee81c76ac427a">BootloaderAPI_WriteLock</a>)(uint8_t LockBits)               = BOOTLOADER_API_CALL(6);</div><div class="line"></div><div class="line"><span class="preprocessor">#define BOOTLOADER_MAGIC_SIGNATURE_START   (BOOTLOADER_API_TABLE_START + (BOOTLOADER_API_TABLE_SIZE - 2))</span></div><div class="line"><span class="preprocessor">#define BOOTLOADER_MAGIC_SIGNATURE         0xDCFB</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define BOOTLOADER_CLASS_SIGNATURE_START   (BOOTLOADER_API_TABLE_START + (BOOTLOADER_API_TABLE_SIZE - 4))</span></div><div class="line"><span class="preprocessor">#define BOOTLOADER_PRINTER_SIGNATURE       0xDF20</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define BOOTLOADER_ADDRESS_START           (BOOTLOADER_API_TABLE_START + (BOOTLOADER_API_TABLE_SIZE - 8))</span></div><div class="line"><span class="preprocessor">#define BOOTLOADER_ADDRESS_LENGTH          4</span></div></div><!-- fragment --><p>From the application the API support of the bootloader can be detected by reading the FLASH memory bytes located at address <code>BOOTLOADER_MAGIC_SIGNATURE_START</code> and comparing them to the value <code>BOOTLOADER_MAGIC_SIGNATURE</code>. The class of bootloader can be determined by reading the FLASH memory bytes located at address <code>BOOTLOADER_CLASS_SIGNATURE_START</code> and comparing them to the value <code>BOOTLOADER_PRINTER_SIGNATURE</code>. The start address of the bootloader can be retrieved by reading the bytes of FLASH memory starting from address <code>BOOTLOADER_ADDRESS_START</code>.</p>
<h2><a class="anchor" id="SSec_API_MemLayout"></a>
Device Memory Map</h2>
<p>The following illustration indicates the final memory map of the device when loaded with the bootloader.</p>
<pre class="fragment">*  +----------------------------+ 0x0000
*  |                            |
*  |                            |
*  |                            |
*  |                            |
*  |                            |
*  |                            |
*  |                            |
*  |                            |
*  |      User Application      |
*  |                            |
*  |                            |
*  |                            |
*  |                            |
*  |                            |
*  |                            |
*  |                            |
*  +----------------------------+ FLASHEND - BOOT_SECTION_SIZE
*  |                            |
*  |   Bootloader Application   |
*  | (Not User App. Accessible) |
*  |                            |
*  +----------------------------+ FLASHEND - 96
*  |   API Table Trampolines    |
*  | (Not User App. Accessible) |
*  +----------------------------+ FLASHEND - 32
*  |    Bootloader API Table    |
*  |   (User App. Accessible)   |
*  +----------------------------+ FLASHEND - 8
*  |   Bootloader ID Constants  |
*  |   (User App. Accessible)   |
*  +----------------------------+ FLASHEND
*  </pre><h1><a class="anchor" id="Sec_KnownIssues"></a>
Known Issues:</h1>
<dl class="section user"><dt>On Linux machines, new firmware fails to be sent to the device via CUPS.</dt><dd>Only a limited subset of normal printer functionality is exposed via the bootloader, causing CUPS to reject print requests from applications that are unable to handle true plain-text printing. For best results, the low level <code>lpr</code> command should be used to print new firmware to the bootloader.</dd></dl>
<h1><a class="anchor" id="Sec_Options"></a>
Project Options</h1>
<p>The following defines can be found in this demo, which can control the demo behaviour when defined, or changed in value.</p>
<table class="doxtable">
<tr>
<td>None   </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
